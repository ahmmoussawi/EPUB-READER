<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MOUSSAWI READER</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3/dist/epub.min.js"></script>

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="turn.min.js"></script>
    <link rel="stylesheet" type="text/css" href="Style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <style type="text/css">
        body {
            display: Block;

        }

        #viewer {
            width: 290px;
            height: 700px;
            box-shadow: 0 0 4px #ccc;
            padding: 10px 10px 0px 10px;
            margin: 5px auto;
            background: white;
            transition: opacity 0.5s ease;
            opacity: 1;
        }
        .hidden {
            opacity: 0;
        }
        #magazine{
            width:100%;
            height:752px;
        }
        #magazine .turn-page{
            background-color:rgba(248, 243, 243, 0.89);
            background-size:100% 100%;
        }
            
        #Showbooks {
                width: 100px;
                height: 20px;
                font-size: 10px;
                text-align: center;
                display: flex;
                justify-content: center;
                
        }
        
        @media only screen and (min-device-width : 320px) and (max-device-width : 667px) {
            #viewer {
                width: auto !important;
                height: 90%;
            }

            #viewer iframe {
                /* pointer-events: none; */
            }

            .arrow {
                position: inherit;
                display: block;
            }
           
        }
    </style>
</head>

<body>
    <button id="Showbooks">Show Books</button>
    <ul id="bookList">
        <!-- List of books will be populated here -->
    </ul>
    <div id="header">
        <a href="#" id="navArrowLeft" class="header-icon"><i class="header-icon fas fa-arrow-left"></i></a>
        <div id="icons-container">  
            <i class="header-icon fas fa-thumbtack" id="pinIcon"></i>
            <i class="header-icon fas fa-search" id="searchIcon"></i>
            <i class="header-icon fas fa-list" id="listIcon"></i>
        </div>
    </div>
    <!-- search model-->
    <div id="searchModal" class="search-modal">
        <div class="search-modal-content">
            <span class="close">&times;</span>
            <input type="text" id="bookSearchInput" placeholder="Search in book...">
            <div id="searchResults" class="search-results">
                <!-- Search results will be displayed here -->
            </div>
        </div>
    </div>


    <!-- <div id="title"></div> -->
    <div class="custom-select">
        <div class="selected-value">chapter</div>
        <ul class="options-list selecthidden">
            <input type="text" id="custom-select-search" placeholder="Search...">
            <!-- Add more options as needed -->
        </ul>
    </div>
    <!-- <div id="title"></div> -->
    <select id="toc"></select>
    <div id="viewer"></div>
    <a id="prev" href="#prev" class="arrow">‹</a>
    <a id="next" href="#next" class="arrow">›</a>

    <script>

        //table of content search 
        document.getElementById('custom-select-search').addEventListener('input', function (e) {
                var searchValue = e.target.value.toLowerCase();
                var options = document.querySelectorAll('.custom-select .options-list li');

                options.forEach(function (option) {
                    var text = option.textContent.toLowerCase();
                    if (text.includes(searchValue)) {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                });
            });

        //open drop down on lst click
        document.getElementById('listIcon').addEventListener('click', function () {
        document.querySelector('.custom-select .selected-value').click();
         });

         //load the book manully this will be changed later
         
        document.getElementById("Showbooks").onclick = function() {
            document.getElementById('bookList').innerHTML = '';
             var books = [
                { title: "Al Din AlQayem", url: "test1.epub" },
                { title: "Auction Book", url: "pg72176.epub" }
                // Add more books as needed
            ];

            var bookList = document.getElementById('bookList');

            

            books.forEach(function(book) {
                var listItem = document.createElement('li');
                listItem.textContent = book.title;
                listItem.onclick = function() {
                    document.getElementById('viewer').innerHTML = '';
                    document.getElementById('toc').innerHTML = '';
                    loadEpub(book.url);
                };
                bookList.appendChild(listItem);
            });
        };
        

        //epub begining

        var params = URLSearchParams && new URLSearchParams(document.location.search.substring(1));
        var url = params && params.get("url") && decodeURIComponent(params.get("url"));
        var currentSectionIndex = (params && params.get("loc")) ? params.get("loc") : undefined;

        function loadEpub(bookUrl) {
                // Load the epub links
                var book = ePub(url || "test1.epub");
                var rendition = book.renderTo("viewer", {
                    width: "100%",
                    height: 700,
                    spread: "none" // Set spread to none for single page view
                });

                rendition.display(currentSectionIndex);

                book.ready.then(function () {

                    var next = document.getElementById("next");

                    next.addEventListener("click", function (e) {
                        book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
                        e.preventDefault();
                    }, false);

                    var prev = document.getElementById("prev");
                    prev.addEventListener("click", function (e) {
                        book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
                        e.preventDefault();
                    }, false);

                    var keyListener = function (e) {

                        // Left Key
                        if ((e.keyCode || e.which) == 37) {
                            book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
                        }

                        // Right Key
                        if ((e.keyCode || e.which) == 39) {
                            book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
                        }

                    };

                    rendition.on("keyup", keyListener);
                    document.addEventListener("keyup", keyListener, false);

                })

                var title = document.getElementById("title");

                rendition.on("rendered", function (section) {
                    var current = book.navigation && book.navigation.get(section.href);

                    if (current) {
                        var $select = document.getElementById("toc");
                        var $selected = $select.querySelector("option[selected]");
                        if ($selected) {
                            $selected.removeAttribute("selected");
                        }

                        var $options = $select.querySelectorAll("option");
                        for (var i = 0; i < $options.length; ++i) {
                            let selected = $options[i].getAttribute("ref") === current.href;
                            if (selected) {
                                $options[i].setAttribute("selected", "");
                            }
                        }
                    }

                });

                rendition.on("relocated", function (location) {
                console.log(location);

                var next = book.package.metadata.direction === "rtl" ? document.getElementById("prev") : document.getElementById("next");
                var prev = book.package.metadata.direction === "rtl" ? document.getElementById("next") : document.getElementById("prev");

                if (location.atEnd) {
                    next.style.visibility = "hidden";
                } else {
                    next.style.visibility = "visible";
                }

                if (location.atStart) {
                    prev.style.visibility = "hidden";
                } else {
                    prev.style.visibility = "visible";
                }

                // Update custom select based on current location
                var current = book.navigation && book.navigation.get(location.start.href);
                var $customSelectList = document.querySelector('.custom-select .options-list');
                var $selectedValue = document.querySelector('.custom-select .selected-value');

                if (current) {
                    updateCustomSelect(current.href);
                    var $options = $customSelectList.querySelectorAll('li');
                    $options.forEach(function (option) {
                        if (option.getAttribute('data-ref') === current.href) {
                            $selectedValue.textContent = option.textContent;
                        }
                    });
                }
                // When selecting an option from the custom select
                    var $customSelectList = document.querySelector('.custom-select .options-list');
                    $customSelectList.addEventListener('click', function (event) {
                        if (event.target.tagName.toLowerCase() === 'li') {
                            updateCustomSelect(event.target.getAttribute('data-ref'));
                            // Hide the custom select list
                            $customSelectList.classList.add('selecthidden');
                        }
                    });
            });

                rendition.on("layout", function (layout) {
                    let viewer = document.getElementById("viewer");
                    viewer.classList.add('single'); // Ensure single page layout
                });

                window.addEventListener("unload", function () {
                    console.log("unloading");
                    this.book.destroy();
                });

               // ...

            book.loaded.navigation.then(function (toc) {
                var $select = document.getElementById("toc"),
                    $customSelect = document.querySelector('.custom-select'),
                    $customSelectList = $customSelect.querySelector('.options-list'),
                    $selectedValue = $customSelect.querySelector('.selected-value'),
                    docfrag = document.createDocumentFragment();

                toc.forEach(function (chapter, index) {
                    var option = document.createElement("option");
                    var customOption = document.createElement("li");

                    option.textContent = chapter.label;
                    option.setAttribute("ref", chapter.href);

                    customOption.textContent = chapter.label;
                    customOption.setAttribute("data-ref", chapter.href);
                    customOption.onclick = function () {
                        $selectedValue.textContent = chapter.label;
                        $customSelectList.classList.add('selecthidden');
                        rendition.display(chapter.href);
                    };

                    docfrag.appendChild(option);
                    $customSelectList.appendChild(customOption);
                });

                $select.appendChild(docfrag);

                // Open/close custom select
                $selectedValue.onclick = function () {
                    $customSelectList.classList.toggle('selecthidden');
                };

                // Synchronize custom select with TOC select
                $select.onchange = function () {
                    var index = $select.selectedIndex,
                        url = $select.options[index].getAttribute("ref"),
                        text = $select.options[index].textContent;

                    $selectedValue.textContent = text;
                    rendition.display(url);
                    return false;
                };
            });
            function updateCustomSelect(currentChapterHref) {
                var $customSelectList = document.querySelector('.custom-select .options-list');
                var $selectedValue = document.querySelector('.custom-select .selected-value');
                var $options = $customSelectList.querySelectorAll('li');
                $options.forEach(function (option) {
                    if (option.getAttribute('data-ref') === currentChapterHref) {
                        $selectedValue.textContent = option.textContent;
                        // Highlight the selected option
                        option.classList.add('custom-option-selected');
                        // Scroll to the selected option
                        option.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        option.classList.remove('custom-option-selected');
                    }
                });
            }


            //search model 
            document.getElementById('searchIcon').addEventListener('click', function () {
    var modal = document.getElementById('searchModal');
    modal.style.display = 'block'; // Display the modal
    modal.style.animation = 'slideUp 0.5s'; // Apply the animation
});

            // Get the modal
            var modal = document.getElementById("searchModal");

            // Get the <span> element that closes the modal
            var span = document.getElementsByClassName("close")[0];

            // When the user clicks on <span> (x), close the modal
            span.onclick = function () {
                modal.style.display = "none";
            }

            // Close the modal if the user clicks anywhere outside of it
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            // Implement search functionality
            document.getElementById('bookSearchInput').addEventListener('input', function (e) {
                var searchValue = e.target.value;

                if (searchValue.length > 2) { // Search when there are 3 or more characters
                    // Function to search the book content
                    searchBookContent(searchValue);
                } else {
                    document.getElementById('searchResults').innerHTML = '';
                }
            });

            function searchBookContent(query) {
    //var book = ePub("path/to/book/"); // Load your book
    var results = document.getElementById('searchResults');
    results.innerHTML = ''; // Clear previous results

    book.loaded.navigation.then(function(toc) {
        toc.forEach(function(chapter) {
            book.load(chapter.href).then(function(contents) {
                var doc = contents.document;
                var text = doc.body.textContent || "";

                if(text.toLowerCase().includes(query.toLowerCase())) {
                    var element = document.createElement('div');
                    element.innerText = "Found in: " + chapter.label;
                    results.appendChild(element);
                }
            });
        });
    });
}




            
                
            //swipe effects with jquery
            /*
            $(window).ready(function () {
                    $('#magazine').turn({
                        display: 'single',
                        acceleration: true,
                        gradients: !$.isTouch,
                        elevation: 50,
                        when: {
                            turned: function (e, page) {
                                /*console.log('Current view: ', $(this).turn('view'));
                            }
                        }
                    });
                });


                $(window).bind('keydown', function (e) {

                    if (e.keyCode == 37)
                        $('#magazine').turn('previous');
                    else if (e.keyCode == 39)
                        $('#magazine').turn('next');

                });
                */

        }

    </script>

</body>

</html>